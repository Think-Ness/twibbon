<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Twibbon Maker Modern</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
</head>
<body class="bg-gradient-to-br from-slate-100 via-white to-slate-200 min-h-screen flex justify-center items-center font-sans text-gray-800">

  <div class="bg-white shadow-xl rounded-2xl p-6 w-full max-w-3xl space-y-6">
    <div class="flex items-center justify-center gap-3">
      <img src="assets/logo.png" alt="Logo" class="w-10 h-10 object-contain" />
      <h1 class="text-2xl font-bold">Twibbon Maker Modern</h1>
    </div>

    <p class="text-center text-gray-500 text-sm">
      Upload foto/video ‚Üí pilih twibbon ‚Üí atur posisi & zoom ‚Üí klik <b>Generate</b> üé®
    </p>

    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
      <label class="cursor-pointer bg-slate-100 hover:bg-blue-50 border border-slate-200 text-center py-2 rounded-lg text-sm font-medium transition">
        Upload / Kamera
        <input id="imgInput" type="file" accept="image/*,video/*" class="hidden">
      </label>

      <select id="overlaySelect"
        class="border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400">
        <option value="">Pilih Twibbon</option>
        <option value="assets/twibbon1.png">Twibbon 1</option>
        <option value="assets/twibbon2.png">Twibbon 2</option>
      </select>

      <select id="ratioSelect"
        class="border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400">
        <option value="1">1:1</option>
        <option value="16/9">16:9</option>
        <option value="9/16">9:16</option>
      </select>
    </div>

    <div class="relative">
      <canvas id="canvas" width="800" height="800" class="w-full bg-slate-900 rounded-xl touch-none"></canvas>
      <div class="absolute top-2 right-2 flex gap-2">
        <button id="zoomIn" class="bg-white/80 rounded-full p-2 shadow hover:bg-white">‚ûï</button>
        <button id="zoomOut" class="bg-white/80 rounded-full p-2 shadow hover:bg-white">‚ûñ</button>
        <button id="centerImg" class="bg-white/80 rounded-full p-2 shadow hover:bg-white">üîÑÔ∏è</button>
      </div>
    </div>

    <div class="w-full bg-slate-200 rounded-full h-3">
      <div id="progress" class="bg-blue-500 h-3 rounded-full w-0 transition-all"></div>
    </div>

    <div class="text-center">
      <button id="generate" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-semibold transition">
        Generate & Download
      </button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let userMedia = null, overlayImg = null;
    let offset = {x:0,y:0}, scale=1;
    const imgInput=document.getElementById('imgInput');
    const overlaySelect=document.getElementById('overlaySelect');
    const ratioSelect=document.getElementById('ratioSelect');
    const generateBtn=document.getElementById('generate');
    const progress=document.getElementById('progress');
    const zoomIn=document.getElementById('zoomIn');
    const zoomOut=document.getElementById('zoomOut');
    const centerImg=document.getElementById('centerImg');

    function redraw(){
      ctx.fillStyle='#111827';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      if(userMedia){
        const iw=userMedia.videoWidth||userMedia.width;
        const ih=userMedia.videoHeight||userMedia.height;
        const r=Math.max(canvas.width/iw,canvas.height/ih);
        const dw=iw*r*scale, dh=ih*r*scale;
        const dx=(canvas.width-dw)/2+offset.x, dy=(canvas.height-dh)/2+offset.y;
        ctx.drawImage(userMedia,dx,dy,dw,dh);
      }
      if(overlayImg) ctx.drawImage(overlayImg,0,0,canvas.width,canvas.height);
    }

    function setCanvasRatio(){
      const ratio = eval(ratioSelect.value);
      canvas.height = canvas.width / ratio;
      redraw();
    }
    ratioSelect.addEventListener('change',setCanvasRatio);

    // zoom, drag
    let dragging=false, last={x:0,y:0};
    canvas.addEventListener('pointerdown',e=>{dragging=true;last={x:e.clientX,y:e.clientY}});
    canvas.addEventListener('pointermove',e=>{
      if(!dragging)return;
      offset.x+=e.clientX-last.x;
      offset.y+=e.clientY-last.y;
      last={x:e.clientX,y:e.clientY};
      redraw();
    });
    canvas.addEventListener('pointerup',()=>dragging=false);
    zoomIn.onclick=()=>{scale=Math.min(scale*1.1,4);redraw();}
    zoomOut.onclick=()=>{scale=Math.max(scale*0.9,0.3);redraw();}
    centerImg.onclick=()=>{offset={x:0,y:0};scale=1;redraw();}

    // load media
    imgInput.addEventListener('change', e=>{
      const f=e.target.files[0]; if(!f)return;
      const url=URL.createObjectURL(f);
      if(f.type.startsWith('video/')){
        const vid=document.createElement('video');
        vid.src=url; vid.muted=true; vid.loop=true; vid.play();
        vid.onloadeddata=()=>{userMedia=vid; redraw();}
      }else{
        const img=new Image();
        img.onload=()=>{userMedia=img; redraw();}
        img.src=url;
      }
    });

    overlaySelect.addEventListener('change',()=>{
      if(!overlaySelect.value){overlayImg=null;redraw();return;}
      const img=new Image();
      img.onload=()=>{overlayImg=img;redraw();}
      img.src=overlaySelect.value;
    });

    // generate
    generateBtn.addEventListener('click', async ()=>{
      if(!userMedia) return alert('Upload dulu ya!');
      if(userMedia instanceof HTMLVideoElement){
        await renderVideo(userMedia);
      }else{
        const a=document.createElement('a');
        a.href=canvas.toDataURL('image/png');
        a.download='twibbon.png';
        a.click();
      }
    });

    // video render
    async function renderVideo(video){
      const { createFFmpeg } = FFmpeg;
      const ffmpeg = createFFmpeg({ log: true });
      progress.style.width='5%';
      await ffmpeg.load();
      progress.style.width='20%';

      const fps = 30;
      const frames = [];
      video.pause(); video.currentTime=0;
      const dur = video.duration;
      for(let t=0;t<dur;t+=1/fps){
        await new Promise(r=>{
          video.currentTime=t;
          video.onseeked=()=>{
            redraw();
            frames.push(canvas.toDataURL('image/jpeg',0.9));
            r();
          };
        });
      }
      progress.style.width='60%';

      for(let i=0;i<frames.length;i++){
        ffmpeg.FS('writeFile', `frame${i}.jpg`, await fetchFile(frames[i]));
      }
      const txt = frames.map((_,i)=>`file 'frame${i}.jpg'`).join('\n');
      ffmpeg.FS('writeFile', 'input.txt', new TextEncoder().encode(txt));

      await ffmpeg.run('-r','30','-f','concat','-safe','0','-i','input.txt','-vf','format=yuv420p','output.mp4');
      const data = ffmpeg.FS('readFile','output.mp4');
      const url = URL.createObjectURL(new Blob([data.buffer], {type:'video/mp4'}));
      progress.style.width='100%';

      const a=document.createElement('a');
      a.href=url; a.download='twibbon-video.mp4'; a.click();
      setTimeout(()=>progress.style.width='0%',3000);
    }
  </script>
</body>
</html>
